<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_mail_app" name="AJM Mail App">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs">
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/my">My Account</a></li>
                    <li class="breadcrumb-item active">Mail</li>
                </ul>
            </t>
            <div class="container o_portal_wrap mt-4">
                <div class="d-flex align-items-center mb-3">
                    <h2 class="mb-0">Mail</h2>
                </div>
                <t t-if="error">
                    <div class="alert alert-danger" role="alert">
                        <t t-esc="error"/>
                        <t t-if="not gmail_ok">
                            <a class="ms-2" href="/my/settings/gmail">Configure Gmail</a>
                        </t>
                    </div>
                </t>

                <ul class="nav nav-pills mb-3">
                    <li class="nav-item"><a t-attf-class="nav-link #{'active' if box=='inbox' else ''}" href="/my/mail?box=inbox">Inbox <span class="badge bg-secondary ms-1" t-if="unseen_count"><t t-esc="unseen_count"/></span></a></li>
                    <li class="nav-item"><a class="nav-link" t-attf-class="nav-link #{'active' if box=='sent' else ''}" href="/my/mail?box=sent">Sent</a></li>
                    <li class="nav-item"><a class="nav-link" href="#compose" data-bs-toggle="tab">Compose</a></li>
                </ul>

                <div class="row g-3">
                    <div class="col-12 col-md-5">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span t-esc="box.capitalize()"/>
                                <span class="badge bg-primary" t-if="box=='inbox' and unseen_count">
                                    <t t-esc="unseen_count"/> new
                                </span>
                            </div>
                            <ul class="list-group list-group-flush" style="max-height: 60vh; overflow:auto;">
                                <t t-if="not messages">
                                    <li class="list-group-item text-muted">No messages to display.</li>
                                </t>
                                <t t-foreach="messages" t-as="m">
                                    <li class="list-group-item">
                                        <a t-attf-href="/my/mail/message?box=#{box}&amp;id=#{m.get('imap_id')}">
                                            <div class="fw-semibold" t-esc="m.get('subject') or '(no subject)'"/>
                                            <div class="small text-muted">
                                                <t t-esc="m.get('from')"/>
                                                <span class="mx-1">â€¢</span>
                                                <t t-esc="m.get('date')"/>
                                            </div>
                                        </a>
                                    </li>
                                </t>
                            </ul>
                        </div>
                    </div>
                    <div class="col-12 col-md-7">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Compose</span>
                                <div class="d-flex align-items-center" style="gap:.5rem;">
                                    <select class="form-select form-select-sm" id="tpl_select" style="width:auto;">
                                        <option value="">Choose format...</option>
                                        <t t-foreach="templates" t-as="t">
                                            <option t-att-value="t.get('id')" t-att-data-subject="t.get('subject')" t-att-data-body="t.get('body_html')" t-esc="t.get('name')"/>
                                        </t>
                                    </select>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="tpl_apply">Apply</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="tpl_delete">Delete</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <form action="/my/mail/send" method="post" enctype="multipart/form-data">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <div class="mb-2">
                                        <label class="form-label">To</label>
                                        <input class="form-control" name="email_to" placeholder="one@example.com, two@example.com" list="suggest_to" t-att-value="prefill_to"/>
                                        <datalist id="suggest_to">
                                            <!-- Optional: could be filled via JS using /my/mail/suggest -->
                                        </datalist>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Cc</label>
                                        <input class="form-control" name="email_cc" placeholder="cc@example.com" t-att-value="prefill_cc"/>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Bcc</label>
                                        <input class="form-control" name="email_bcc" placeholder="bcc@example.com" t-att-value="prefill_bcc"/>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Subject</label>
                                        <input type="text" class="form-control" name="subject" required="required" t-att-value="prefill_subject"/>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Attachments</label>
                                        <input type="file" class="form-control" name="attachments" multiple="multiple"/>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Body</label>
                                        <textarea class="form-control" name="body" id="mail_body" rows="8" placeholder="Write your message..."></textarea>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        <button type="submit" class="btn btn-primary" t-att-disabled="not gmail_ok">Send</button>
                                    </div>
                                </form>
                                <form action="/my/mail/template/save" method="post" class="mt-3">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <div class="row g-2 align-items-end">
                                        <div class="col-12 col-md-6">
                                            <label class="form-label">Save as format</label>
                                            <input class="form-control" name="tpl_name" placeholder="Format name"/>
                                        </div>
                                        <div class="d-none">
                                            <input type="hidden" name="subject" id="tpl_subject_holder"/>
                                            <textarea name="body" id="tpl_body_holder"></textarea>
                                        </div>
                                        <div class="col-auto">
                                            <button type="submit" class="btn btn-outline-primary" id="tpl_save">Save</button>
                                        </div>
                                    </div>
                                </form>
                                <form action="/my/mail/template/delete" method="post" id="tpl_delete_form" class="d-none">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="tpl_id" id="tpl_delete_id"/>
                                </form>
                                <t t-if="request.session.get('portal_status_message')">
                                    <div class="alert alert-info mt-3" role="alert">
                                        <t t-esc="request.session.get('portal_status_message')"/>
                                    </div>
                                </t>
                            </div>
                        </div>

                        <t t-if="message">
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span t-esc="message.get('subject')"/>
                                    <div class="btn-group">
                                        <a t-attf-href="/my/mail?box=#{box}" class="btn btn-sm btn-outline-secondary">Back</a>
                                        <a t-attf-href="/my/mail?box=#{box}&amp;to=#{reply_to}&amp;subject=Re: #{message.get('subject')}#compose" class="btn btn-sm btn-primary">Reply</a>
                                        <a t-attf-href="/my/mail?box=#{box}&amp;to=#{reply_all}&amp;subject=Re: #{message.get('subject')}#compose" class="btn btn-sm btn-primary">Reply all</a>
                                        <a t-attf-href="/my/mail?box=#{box}&amp;subject=#{forward_subject}#compose" class="btn btn-sm btn-secondary">Forward</a>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2 small text-muted">
                                        From: <t t-esc="message.get('from')"/>
                                        <br/>To: <t t-esc="message.get('to')"/>
                                        <t t-if="message.get('cc')"><br/>Cc: <t t-esc="message.get('cc')"/></t>
                                        <br/><t t-esc="message.get('date')"/>
                                    </div>
                                    <div t-raw="body_html"/>
                                    <t t-if="attachments">
                                        <hr/>
                                        <div>
                                            <strong>Attachments</strong>
                                            <ul class="list-unstyled">
                                                <t t-foreach="attachments" t-as="a">
                                                    <li>
                                                        <a t-attf-href="/my/mail/attachment?box=#{box}&amp;id=#{message.get('imap_id')}&amp;part=#{a.get('part_id')}&amp;filename=#{a.get('filename')}">
                                                            <t t-esc="a.get('filename')"/>
                                                        </a>
                                                    </li>
                                                </t>
                                            </ul>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
            <script><![CDATA[
            (function(){
                function lastToken(val){
                    let parts = val.split(',');
                    return parts[parts.length-1].trim();
                }
                function setValueWithAppend(input, label){
                    let val = input.value.trim();
                    if(val && !val.endsWith(',')) val += ', ';
                    input.value = (val ? val + ' ' : '') + label;
                }
                async function suggest(input, datalist){
                    const token = lastToken(input.value);
                    if(!token) { datalist.innerHTML=''; return; }
                    try{
                        const res = await fetch('/my/mail/suggest', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({q: token})});
                        const data = await res.json();
                        datalist.innerHTML = '';
                        (data || []).forEach(item => {
                            const opt = document.createElement('option');
                            opt.value = item.label;
                            datalist.appendChild(opt);
                        });
                    }catch(e){ /* ignore */ }
                }
                const toInput = document.querySelector('input[name="email_to"]');
                const ccInput = document.querySelector('input[name="email_cc"]');
                const bccInput = document.querySelector('input[name="email_bcc"]');
                const toList = document.getElementById('suggest_to');
                if(toInput && toList){ toInput.addEventListener('input', ()=>suggest(toInput, toList)); }
                if(ccInput && toList){ ccInput.addEventListener('input', ()=>suggest(ccInput, toList)); }
                if(bccInput && toList){ bccInput.addEventListener('input', ()=>suggest(bccInput, toList)); }
                // Apply template
                const tplSelect = document.getElementById('tpl_select');
                const tplApply = document.getElementById('tpl_apply');
                const tplDeleteBtn = document.getElementById('tpl_delete');
                const tplDeleteForm = document.getElementById('tpl_delete_form');
                const tplDeleteId = document.getElementById('tpl_delete_id');
                const subjectInput = document.querySelector('input[name="subject"]');
                const bodyInput = document.getElementById('mail_body');
                if(tplApply && tplSelect && subjectInput && bodyInput){
                    tplApply.addEventListener('click', ()=>{
                        const opt = tplSelect.options[tplSelect.selectedIndex];
                        if(!opt || !opt.value) return;
                        const subj = opt.getAttribute('data-subject') || '';
                        const body = opt.getAttribute('data-body') || '';
                        if(subj) subjectInput.value = subj;
                        if(body){
                            // crude strip tags to textarea
                            const tmp = document.createElement('div');
                            tmp.innerHTML = body;
                            bodyInput.value = tmp.innerText;
                        }
                    });
                }
                if(tplDeleteBtn && tplSelect && tplDeleteForm && tplDeleteId){
                    tplDeleteBtn.addEventListener('click', ()=>{
                        const opt = tplSelect.options[tplSelect.selectedIndex];
                        if(!opt || !opt.value) {
                            alert('Select a format to delete.');
                            return;
                        }
                        if(confirm('Delete format "' + opt.text + '"?')){
                            tplDeleteId.value = opt.value;
                            tplDeleteForm.submit();
                        }
                    });
                }
                // Prepare save template hidden fields
                const saveBtn = document.getElementById('tpl_save');
                const holderSubject = document.getElementById('tpl_subject_holder');
                const holderBody = document.getElementById('tpl_body_holder');
                const saveForm = saveBtn ? saveBtn.closest('form') : null;
                if(saveForm && holderSubject && holderBody && subjectInput && bodyInput){
                    saveForm.addEventListener('submit', ()=>{
                        holderSubject.value = subjectInput.value || '';
                        holderBody.value = bodyInput.value || '';
                    });
                }
            })();
            ]]></script>
        </t>
    </template>
</odoo>
